### Транспорт в SKABEN
| описан в `core`

Транспорт (связность между различными модулями сервера и внешними устройствами (периферийными устройствами или клиентами), управляемыми через MQTT) реализован через набор очередей в RabbitMQ и воркеров, которые стартуют в отдельных docker-контейнерах и являются паблишерами\подписчиками этих очередей.

Роутинг между очередями описан внутри кода воркеров.

#### Логически транспорт состоит из:

- очередь входящих MQTT-пакетов
- очередь исходящих MQTT-пакетов
- очередь внутренних событий
    - основной обработчик событий
    - отправка конфигурации клиентам
    - сохранение конфигурации клиентов

### Пакеты и События

#### Пакеты
| описаны в `core.transport.packets`

Описывают взаимодействие с периферийными устройствами, используются как структура данных в очередях MQTT.

#### События
| базовое событие описано в `core.transport.events`

Описывают внутренние серверные взаимодействия, реакции и изменения состояния. В каждом модуле (приложении Django) предполагается наличие `event_types` и `event_handlers` файлов, отвечающих за структуру события и обработчики, с ним связанные.

### Регулярные задачи
| описаны в `core.scheduler`

модуль `tasks` - описывает рутинные задачи \
модуль `service` - описывает сбор и запуск тасок

Scheduler запускается в одноименном контейнере, представляет собой один async loop. Синхронные задачи выполняются через `sync_to_async`.

### Управление созданием очередей, привязка воркеров
| описано в `core.transport.config`

Происходит при старте контейнеров воркеров через management команду Django (описано в `core.management.commands`)

В этом процессе создается очередь с определенным именем, привязывается к существующему exchange в RabbitMQ, и на очередь назначается обработчик.

Все обработчики очередей описаны в `core.worker_queue_handlers`

#### Основные используемые очереди и функции обработчиков:

##### Ask
| описан в `core.worker_queue_handlers.ask_mqtt_handler`

Обрабатывает входящие MQTT-пакеты, маркированные ask. в начале топика. RabbitMQ настроен таким образом, чтобы фильтровать такие события в отдельный exchange + очередь, где они обрабатываются воркером. MQTT пакет распаковывается, роутинг-ключ приводится к внутреннему формату (заменяются `/` на `.`).

Исходящие пакеты отправляются в очередь `internal`

##### State_update
| описан в `core.worker_queue_handlers.state_update`

Сохраняет конфигурацию от клиентов в БД. Simple-устройства игнорируются.

##### Client_update
| описан в `core.worker_queue_handlers.client_update`

Отправляет конфигурации из БД клиентам, включая simple-устройства.

##### Internal

Обрабатывает события, связанные с изменениями состояния конфигурации клиентов или состоянием сервера. Многие серверные операции (изменение уровня тревоги) - создают собственные события в этой очереди.

В этом же обработчике применяются дополнительные правила, путем дописывания инструкций в метод `handle_event`